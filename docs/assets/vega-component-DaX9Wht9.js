import{aB as e,aC as t,aD as n,d as a,aE as r,aF as i,j as o,E as s,af as c,S as l,aG as u,aH as m,aI as p,L as d,aJ as f,aK as h,aL as y,aM as g,aN as v,ap as k,aO as w}from"./index-D3XtisvU.js";import{M as j}from"./compile-CsTNKzEk.js";import{a as x}from"./VegaLite-D07JSyC_.js";import"./time-CJGz9Moa.js";import"./timer-DFzT7np-.js";import"./linear-BuATvq_r.js";import"./init-DLRA0X12.js";import"./range-CtcPcB_L.js";import"./zoom-COrs4lFh.js";import"./ordinal-DDUp3AbE.js";import"./colors-bszWmPJw.js";import"./arc-Cuwikxov.js";import"./step-BwsUM5iJ.js";import"./index-BelAJDbG.js";const b=new Set(["boxplot","errorband","errorbar"]),S={getMarkType(e){const t="string"==typeof e?e:e.type;if(b.has(t))throw new Error("Not supported");return t},isInteractive(e){const t="string"==typeof e?e:e.type;return!b.has(t)},makeClickable(e){const t="string"==typeof e?e:e.type;return t in j?"string"==typeof e?{type:e,cursor:"pointer",tooltip:!0}:{...e,type:t,cursor:"pointer",tooltip:!0}:e},getOpacity:e=>"string"==typeof e?null:"opacity"in e&&"number"==typeof e.opacity?e.opacity:null};const _=new Set(["color","fill","fillOpacity","opacity","shape","size"]);function P(e,t,n,a){const r={and:n.map((e=>({param:e})))};if("opacity"===e){const e=S.getOpacity(a)||1;return{...t,opacity:{condition:{test:r,value:e},value:e/5}}}return t}const M={point:e=>null==e?"select_point":`select_point_${e}`,interval:e=>null==e?"select_interval":`select_interval_${e}`,legendSelection:e=>`legend_selection_${e}`,HIGHLIGHT:"highlight",PAN_ZOOM:"pan_zoom",hasPoint:e=>e.some((e=>e.startsWith("select_point"))),hasInterval:e=>e.some((e=>e.startsWith("select_interval"))),hasLegend:e=>e.some((e=>e.startsWith("legend_selection"))),hasPanZoom:e=>e.some((e=>e.startsWith("pan_zoom")))},O={highlight:()=>({name:M.HIGHLIGHT,select:{type:"point",on:"mouseover"}}),interval:(e,t)=>({name:M.interval(t),select:{type:"interval",encodings:A(e),mark:{fill:"#669EFF",fillOpacity:.07,stroke:"#669EFF",strokeOpacity:.4},on:"[mousedown[!event.metaKey], mouseup] > mousemove[!event.metaKey]",translate:"[mousedown[!event.metaKey], mouseup] > mousemove[!event.metaKey]"}}),point:(e,t)=>({name:M.point(t),select:{type:"point",encodings:A(e),on:"click[!event.metaKey]"}}),legend:e=>({name:M.legendSelection(e),select:{type:"point",fields:[e]},bind:"legend"}),panZoom:()=>({name:M.PAN_ZOOM,bind:"scales",select:{type:"interval",on:"[mousedown[event.metaKey], window:mouseup] > window:mousemove!",translate:"[mousedown[event.metaKey], window:mouseup] > window:mousemove!",zoom:"wheel![event.metaKey]"}})};function A(e){switch(S.getMarkType(e.mark)){case j.image:case j.trail:return;case j.area:case j.arc:return["color"];case j.bar:{const t=function(e){var t,n;if(!e||!("mark"in e))return;const a=null==(t=e.encoding)?void 0:t.x,r=null==(n=e.encoding)?void 0:n.y;if(a&&"type"in a&&"nominal"===a.type)return"vertical";if(r&&"type"in r&&"nominal"===r.type)return"horizontal";if(a&&"aggregate"in a)return"horizontal";if(r&&"aggregate"in r)return"vertical";return}(e);return"horizontal"===t?["y"]:"vertical"===t?["x"]:void 0}case j.circle:case j.geoshape:case j.line:case j.point:case j.rect:case j.rule:case j.square:case j.text:case j.tick:return["x","y"]}}function I(e){if("params"in e&&e.params&&e.params.length>0){return e.params.filter((e=>null!=e&&("select"in e&&void 0!==e.select))).map((e=>e.name))}return"layer"in e?[...new Set(e.layer.flatMap(I))]:[]}function N(e,t){var n,a;let{chartSelection:r=!0,fieldSelection:i=!0}=t;if(!r&&!i)return e;(null==(n=e.params)?void 0:n.some((e=>"legend"===e.bind)))&&(i=!1);if((null==(a=e.params)?void 0:a.some((e=>!e.bind)))&&(r=!1),"vconcat"in e){const t=e.vconcat.map((e=>"mark"in e?V(e):e));return{...e,vconcat:t}}if("hconcat"in e){const t=e.hconcat.map((e=>"mark"in e?V(e):e));return{...e,hconcat:t}}if("layer"in e){const t=e.layer.map(((e,t)=>{if(!("mark"in e))return e;let n=e;return n=K(n,r,t),n=V(n),0===t&&(n=L(n)),n}));return{...e,layer:t}}if(!("mark"in e))return e;if(!S.isInteractive(e.mark))return e;let o=e;return o=function(e,t){if(!1===t)return e;let n=function(e){if(!e||!("encoding"in e))return[];const{encoding:t}=e;return t?Object.entries(t).flatMap((e=>{const[t,n]=e;return n&&_.has(t)?"field"in n&&"string"==typeof n.field?[n.field]:"condition"in n&&n.condition&&"object"==typeof n.condition&&"field"in n.condition&&n.condition.field&&"string"==typeof n.condition.field?[n.condition.field]:[]:[]})):[]}(e);Array.isArray(t)&&(n=n.filter((e=>t.includes(e))));const a=n.map((e=>O.legend(e))),r=[...e.params||[],...a];return{...e,params:r}}(o,i),o=K(o,r,void 0),o=V(o),o=L(o),o}function K(e,t,n){if(!1===t)return e;let a;try{a=S.getMarkType(e.mark)}catch{return e}if("geoshape"===a)return e;const r=!0===t?function(e){switch(e){case"arc":case"area":return["point"];case"text":case"bar":default:return["point","interval"];case"line":return}}(a):[t];if(!r)return e;const i=r.map((t=>"interval"===t?O.interval(e,n):O.point(e,n))),o=[...e.params||[],...i];return{...e,params:o}}function L(e){let t;try{t=S.getMarkType(e.mark)}catch{}if("geoshape"===t)return e;const n=e.params||[];return n.some((e=>"scales"===e.bind))?e:{...e,params:[...n,O.panZoom()]}}function V(e){const t="encoding"in e?e.encoding:void 0,n=e.params||[],a=n.map((e=>e.name));return 0===n.length?e:S.isInteractive(e.mark)?{...e,mark:S.makeClickable(e.mark),encoding:P("opacity",t||{},a,e.mark)}:e}function z(e){return(t=e,(null==t?void 0:t.schema)&&Array.isArray(t.schema.fields)&&"function"==typeof t.toArray?e:function(e){return n(e,{useProxy:!0})}(e)).toArray();var t}z.responseType="arrayBuffer",i("arrow",z);const T=n=>{const i=a.c(11),{value:c,setValue:l,chartSelection:u,fieldSelection:m,spec:p}=n;let d,f;i[0]!==p?(d=async()=>async function(n){if(!n)return n;const a="datasets"in n?{...n.datasets}:{},r=async n=>{if(!n)return n;if("layer"in n){const e=await Promise.all(n.layer.map(r));n={...n,layer:e}}if("hconcat"in n){const e=await Promise.all(n.hconcat.map(r));n={...n,hconcat:e}}if("vconcat"in n){const e=await Promise.all(n.vconcat.map(r));n={...n,vconcat:e}}if("spec"in n&&(n={...n,spec:await r(n.spec)}),!n.data)return n;if(!("url"in n.data))return n;let i;try{i=e(n.data.url)}catch{return n}const o=await t(i.href,n.data.format);return a[i.pathname]=o,{...n,data:{name:i.pathname}}},i=await r(n);return 0===Object.keys(a).length?i:{...i,datasets:a}}(p),f=[p],i[0]=p,i[1]=d,i[2]=f):(d=i[1],f=i[2]);const{data:h,error:y}=r(d,f);if(y){let e;return i[3]!==y?(e=o.jsx(s,{error:y}),i[3]=y,i[4]=e):e=i[4],e}if(!h)return null;let g;return i[5]!==u||i[6]!==m||i[7]!==h||i[8]!==l||i[9]!==c?(g=o.jsx(Z,{value:c,setValue:l,chartSelection:u,fieldSelection:m,spec:h}),i[5]=u,i[6]=m,i[7]=h,i[8]=l,i[9]=c,i[10]=g):g=i[10],g},Z=({value:t,setValue:n,chartSelection:a,fieldSelection:r,spec:i})=>{const{theme:s}=c(),v=l.useRef(),[j,b]=l.useState(),S=u(i),_=l.useMemo((()=>N(function(t){return t.data&&"url"in t.data&&(t.data.url=e(t.data.url).href),t}(S),{chartSelection:a,fieldSelection:r})),[S,a,r]),P=l.useMemo((()=>I(_)),[_]),O=m((e=>{n({...t,...e})})),A=u(P),K=l.useMemo((()=>A.reduce(((e,t)=>(M.PAN_ZOOM===t||(e[t]=p(((e,t)=>{d.debug("[Vega signal]",e,t);let n=f.mapValues(t,F);n=f.mapValues(n,E),O({[e]:n})}),100)),e)),{})),[A,O]),L=m((e=>{d.error(e),d.debug(_),b(e)})),V=m((e=>{d.debug("[Vega view] created",e),v.current=e,b(void 0)}));return o.jsxs(o.Fragment,{children:[j&&o.jsxs(h,{variant:"destructive",children:[o.jsx(y,{children:j.message}),o.jsx("div",{className:"text-md",children:j.stack})]}),o.jsxs("div",{className:"relative",onPointerDown:g.stopPropagation(),children:[o.jsx(x,{spec:_,theme:"dark"===s?"dark":void 0,actions:H,signalListeners:K,onError:L,onNewView:V}),(()=>{const e=[];return M.hasPoint(P)&&e.push(["Point selection","click to select a point; hold shift for multi-select"]),M.hasInterval(P)&&e.push(["Interval selection","click and drag to select an interval"]),M.hasLegend(P)&&e.push(["Legend selection","click to select a legend item; hold shift for multi-select"]),M.hasPanZoom(P)&&e.push(["Pan","hold the meta key and drag"],["Zoom","hold the meta key and scroll"]),0===e.length?null:o.jsx(k,{delayDuration:300,side:"left",content:o.jsx("div",{className:"text-xs flex flex-col",children:e.map(((e,t)=>o.jsxs("div",{children:[o.jsxs("span",{className:"font-bold tracking-wide",children:[e[0],":"]})," ",e[1]]},t)))}),children:o.jsx(w,{className:"absolute bottom-1 right-0 m-2 h-4 w-4 cursor-help text-muted-foreground hover:text-foreground"})})})()]})]})},H={source:!1,compiled:!1};function E(e){return e instanceof Set?[...e]:e}function F(e){return Array.isArray(e)?e.map((e=>e instanceof Date&&v(e)?new Date(e).getTime():e)):e}export{T as default};
