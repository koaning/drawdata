import{t as A}from"./graphlib-Dtxn1kuc.js";import{t as G}from"./dagre-B0xEvXH8.js";import"./purify.es-N-2faAGj.js";import"./marked.esm-BZNXs5FA.js";import{u as H}from"./src-Bp_72rVO.js";import{_ as O}from"./step-D7xg1Moj.js";import{t as P}from"./line-x4bpd_8D.js";import{g as R}from"./chunk-S3R3BYOJ-By1A-M0T.js";import{n as m,r as B}from"./src-faGJHwXX.js";import{E as U,b as t,c as C,s as v}from"./chunk-ABZYJK2D-DAD3GlgM.js";import"./chunk-HN2XXSSU-xW6J7MXn.js";import"./chunk-CVBHYZKI-B6tT645I.js";import"./chunk-ATLVNIR6-DsKp3Ify.js";import"./dist-BA8xhrl2.js";import"./chunk-JA3XYJ7Z-BlmyoDCa.js";import"./chunk-JZLCHNYA-DBaJpCky.js";import"./chunk-QXUST7PY-CIxWhn5L.js";import"./chunk-N4CR4FBY-DtYoI569.js";import"./chunk-55IACEB6-DvJ_-Ku-.js";import"./chunk-QN33PNHL-C0IBWhei.js";import{i as I,n as W,t as M}from"./chunk-DI55MBZ5-DpQLXMld.js";var F=m(e=>e.append("circle").attr("class","start-state").attr("r",t().state.sizeUnit).attr("cx",t().state.padding+t().state.sizeUnit).attr("cy",t().state.padding+t().state.sizeUnit),"drawStartState"),J=m(e=>e.append("line").style("stroke","grey").style("stroke-dasharray","3").attr("x1",t().state.textHeight).attr("class","divider").attr("x2",t().state.textHeight*2).attr("y1",0).attr("y2",0),"drawDivider"),_=m((e,i)=>{let o=e.append("text").attr("x",2*t().state.padding).attr("y",t().state.textHeight+2*t().state.padding).attr("font-size",t().state.fontSize).attr("class","state-title").text(i.id),s=o.node().getBBox();return e.insert("rect",":first-child").attr("x",t().state.padding).attr("y",t().state.padding).attr("width",s.width+2*t().state.padding).attr("height",s.height+2*t().state.padding).attr("rx",t().state.radius),o},"drawSimpleState"),j=m((e,i)=>{let o=m(function(g,f,S){let b=g.append("tspan").attr("x",2*t().state.padding).text(f);S||b.attr("dy",t().state.textHeight)},"addTspan"),s=e.append("text").attr("x",2*t().state.padding).attr("y",t().state.textHeight+1.3*t().state.padding).attr("font-size",t().state.fontSize).attr("class","state-title").text(i.descriptions[0]).node().getBBox(),d=s.height,x=e.append("text").attr("x",t().state.padding).attr("y",d+t().state.padding*.4+t().state.dividerMargin+t().state.textHeight).attr("class","state-description"),c=!0,a=!0;i.descriptions.forEach(function(g){c||(o(x,g,a),a=!1),c=!1});let n=e.append("line").attr("x1",t().state.padding).attr("y1",t().state.padding+d+t().state.dividerMargin/2).attr("y2",t().state.padding+d+t().state.dividerMargin/2).attr("class","descr-divider"),h=x.node().getBBox(),p=Math.max(h.width,s.width);return n.attr("x2",p+3*t().state.padding),e.insert("rect",":first-child").attr("x",t().state.padding).attr("y",t().state.padding).attr("width",p+2*t().state.padding).attr("height",h.height+d+2*t().state.padding).attr("rx",t().state.radius),e},"drawDescrState"),Y=m((e,i,o)=>{let s=t().state.padding,d=2*t().state.padding,x=e.node().getBBox(),c=x.width,a=x.x,n=e.append("text").attr("x",0).attr("y",t().state.titleShift).attr("font-size",t().state.fontSize).attr("class","state-title").text(i.id),h=n.node().getBBox().width+d,p=Math.max(h,c);p===c&&(p+=d);let g,f=e.node().getBBox();i.doc,g=a-s,h>c&&(g=(c-p)/2+s),Math.abs(a-f.x)<s&&h>c&&(g=a-(h-c)/2);let S=1-t().state.textHeight;return e.insert("rect",":first-child").attr("x",g).attr("y",S).attr("class",o?"alt-composit":"composit").attr("width",p).attr("height",f.height+t().state.textHeight+t().state.titleShift+1).attr("rx","0"),n.attr("x",g+s),h<=c&&n.attr("x",a+(p-d)/2-h/2+s),e.insert("rect",":first-child").attr("x",g).attr("y",t().state.titleShift-t().state.textHeight-t().state.padding).attr("width",p).attr("height",t().state.textHeight*3).attr("rx",t().state.radius),e.insert("rect",":first-child").attr("x",g).attr("y",t().state.titleShift-t().state.textHeight-t().state.padding).attr("width",p).attr("height",f.height+3+2*t().state.textHeight).attr("rx",t().state.radius),e},"addTitleAndBox"),$=m(e=>(e.append("circle").attr("class","end-state-outer").attr("r",t().state.sizeUnit+t().state.miniPadding).attr("cx",t().state.padding+t().state.sizeUnit+t().state.miniPadding).attr("cy",t().state.padding+t().state.sizeUnit+t().state.miniPadding),e.append("circle").attr("class","end-state-inner").attr("r",t().state.sizeUnit).attr("cx",t().state.padding+t().state.sizeUnit+2).attr("cy",t().state.padding+t().state.sizeUnit+2)),"drawEndState"),X=m((e,i)=>{let o=t().state.forkWidth,s=t().state.forkHeight;if(i.parentId){let d=o;o=s,s=d}return e.append("rect").style("stroke","black").style("fill","black").attr("width",o).attr("height",s).attr("x",t().state.padding).attr("y",t().state.padding)},"drawForkJoinState"),q=m((e,i,o,s)=>{let d=0,x=s.append("text");x.style("text-anchor","start"),x.attr("class","noteText");let c=e.replace(/\r\n/g,"<br/>");c=c.replace(/\n/g,"<br/>");let a=c.split(v.lineBreakRegex),n=1.25*t().state.noteMargin;for(let h of a){let p=h.trim();if(p.length>0){let g=x.append("tspan");if(g.text(p),n===0){let f=g.node().getBBox();n+=f.height}d+=n,g.attr("x",i+t().state.noteMargin),g.attr("y",o+d+1.25*t().state.noteMargin)}}return{textWidth:x.node().getBBox().width,textHeight:d}},"_drawLongText"),Z=m((e,i)=>{i.attr("class","state-note");let o=i.append("rect").attr("x",0).attr("y",t().state.padding),{textWidth:s,textHeight:d}=q(e,0,0,i.append("g"));return o.attr("height",d+2*t().state.noteMargin),o.attr("width",s+t().state.noteMargin*2),o},"drawNote"),T=m(function(e,i){let o=i.id,s={id:o,label:i.id,width:0,height:0},d=e.append("g").attr("id",o).attr("class","stateGroup");i.type==="start"&&F(d),i.type==="end"&&$(d),(i.type==="fork"||i.type==="join")&&X(d,i),i.type==="note"&&Z(i.note.text,d),i.type==="divider"&&J(d),i.type==="default"&&i.descriptions.length===0&&_(d,i),i.type==="default"&&i.descriptions.length>0&&j(d,i);let x=d.node().getBBox();return s.width=x.width+2*t().state.padding,s.height=x.height+2*t().state.padding,s},"drawState"),D=0,K=m(function(e,i,o){let s=m(function(n){switch(n){case M.relationType.AGGREGATION:return"aggregation";case M.relationType.EXTENSION:return"extension";case M.relationType.COMPOSITION:return"composition";case M.relationType.DEPENDENCY:return"dependency"}},"getRelationType");i.points=i.points.filter(n=>!Number.isNaN(n.y));let d=i.points,x=P().x(function(n){return n.x}).y(function(n){return n.y}).curve(O),c=e.append("path").attr("d",x(d)).attr("id","edge"+D).attr("class","transition"),a="";if(t().state.arrowMarkerAbsolute&&(a=U(!0)),c.attr("marker-end","url("+a+"#"+s(M.relationType.DEPENDENCY)+"End)"),o.title!==void 0){let n=e.append("g").attr("class","stateLabel"),{x:h,y:p}=R.calcLabelPosition(i.points),g=v.getRows(o.title),f=0,S=[],b=0,N=0;for(let u=0;u<=g.length;u++){let l=n.append("text").attr("text-anchor","middle").text(g[u]).attr("x",h).attr("y",p+f),y=l.node().getBBox();b=Math.max(b,y.width),N=Math.min(N,y.x),B.info(y.x,h,p+f),f===0&&(f=l.node().getBBox().height,B.info("Title height",f,p)),S.push(l)}let k=f*g.length;if(g.length>1){let u=(g.length-1)*f*.5;S.forEach((l,y)=>l.attr("y",p+y*f-u)),k=f*g.length}let r=n.node().getBBox();n.insert("rect",":first-child").attr("class","box").attr("x",h-b/2-t().state.padding/2).attr("y",p-k/2-t().state.padding/2-3.5).attr("width",b+t().state.padding).attr("height",k+t().state.padding),B.info(r)}D++},"drawEdge"),w,z={},Q=m(function(){},"setConf"),V=m(function(e){e.append("defs").append("marker").attr("id","dependencyEnd").attr("refX",19).attr("refY",7).attr("markerWidth",20).attr("markerHeight",28).attr("orient","auto").append("path").attr("d","M 19,7 L9,13 L14,7 L9,1 Z")},"insertMarkers"),tt=m(function(e,i,o,s){w=t().state;let d=t().securityLevel,x;d==="sandbox"&&(x=H("#i"+i));let c=H(d==="sandbox"?x.nodes()[0].contentDocument.body:"body"),a=d==="sandbox"?x.nodes()[0].contentDocument:document;B.debug("Rendering diagram "+e);let n=c.select(`[id='${i}']`);V(n),L(s.db.getRootDoc(),n,void 0,!1,c,a,s);let h=w.padding,p=n.node().getBBox(),g=p.width+h*2,f=p.height+h*2;C(n,f,g*1.75,w.useMaxWidth),n.attr("viewBox",`${p.x-w.padding}  ${p.y-w.padding} `+g+" "+f)},"draw"),et=m(e=>e?e.length*w.fontSizeFactor:1,"getLabelWidth"),L=m((e,i,o,s,d,x,c)=>{let a=new A({compound:!0,multigraph:!0}),n,h=!0;for(n=0;n<e.length;n++)if(e[n].stmt==="relation"){h=!1;break}o?a.setGraph({rankdir:"LR",multigraph:!0,compound:!0,ranker:"tight-tree",ranksep:h?1:w.edgeLengthFactor,nodeSep:h?1:50,isMultiGraph:!0}):a.setGraph({rankdir:"TB",multigraph:!0,compound:!0,ranksep:h?1:w.edgeLengthFactor,nodeSep:h?1:50,ranker:"tight-tree",isMultiGraph:!0}),a.setDefaultEdgeLabel(function(){return{}});let p=c.db.getStates(),g=c.db.getRelations(),f=Object.keys(p);for(let r of f){let u=p[r];o&&(u.parentId=o);let l;if(u.doc){let y=i.append("g").attr("id",u.id).attr("class","stateGroup");l=L(u.doc,y,u.id,!s,d,x,c);{y=Y(y,u,s);let E=y.node().getBBox();l.width=E.width,l.height=E.height+w.padding/2,z[u.id]={y:w.compositTitleSize}}}else l=T(i,u,a);if(u.note){let y=T(i,{descriptions:[],id:u.id+"-note",note:u.note,type:"note"},a);u.note.position==="left of"?(a.setNode(l.id+"-note",y),a.setNode(l.id,l)):(a.setNode(l.id,l),a.setNode(l.id+"-note",y)),a.setParent(l.id,l.id+"-group"),a.setParent(l.id+"-note",l.id+"-group")}else a.setNode(l.id,l)}B.debug("Count=",a.nodeCount(),a);let S=0;g.forEach(function(r){S++,B.debug("Setting edge",r),a.setEdge(r.id1,r.id2,{relation:r,width:et(r.title),height:w.labelHeight*v.getRows(r.title).length,labelpos:"c"},"id"+S)}),G(a),B.debug("Graph after layout",a.nodes());let b=i.node();a.nodes().forEach(function(r){r!==void 0&&a.node(r)!==void 0?(B.warn("Node "+r+": "+JSON.stringify(a.node(r))),d.select("#"+b.id+" #"+r).attr("transform","translate("+(a.node(r).x-a.node(r).width/2)+","+(a.node(r).y+(z[r]?z[r].y:0)-a.node(r).height/2)+" )"),d.select("#"+b.id+" #"+r).attr("data-x-shift",a.node(r).x-a.node(r).width/2),x.querySelectorAll("#"+b.id+" #"+r+" .divider").forEach(u=>{let l=u.parentElement,y=0,E=0;l&&(l.parentElement&&(y=l.parentElement.getBBox().width),E=parseInt(l.getAttribute("data-x-shift"),10),Number.isNaN(E)&&(E=0)),u.setAttribute("x1",0-E+8),u.setAttribute("x2",y-E-8)})):B.debug("No Node "+r+": "+JSON.stringify(a.node(r)))});let N=b.getBBox();a.edges().forEach(function(r){r!==void 0&&a.edge(r)!==void 0&&(B.debug("Edge "+r.v+" -> "+r.w+": "+JSON.stringify(a.edge(r))),K(i,a.edge(r),a.edge(r).relation))}),N=b.getBBox();let k={id:o||"root",label:o||"root",width:0,height:0};return k.width=N.width+2*w.padding,k.height=N.height+2*w.padding,B.debug("Doc rendered",k,a),k},"renderDoc"),at={parser:W,get db(){return new M(1)},renderer:{setConf:Q,draw:tt},styles:I,init:m(e=>{e.state||(e.state={}),e.state.arrowMarkerAbsolute=e.arrowMarkerAbsolute},"init")};export{at as diagram};
